<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Тест</title>
    <link href="assets/css/style.css" rel="stylesheet">
    <style>
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .option-image {
            max-width: 200px;
            height: auto;
            border-radius: 4px;
            margin-top: 10px;
        }
        .test-nav li {
            cursor: pointer;
            transition: all 0.2s;
        }
        .test-nav li.active {
            background: #3498db;
            color: white;
        }
        .test-nav li.btn-primary {
            background: #2ecc71 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-content" style="margin-left: 0;">
            <div class="page-inner">
                <div class="panel">
                    <div class="row m-b-sm">
                        <div class="col-xs-6">
                            <h1 class="breadcrumb-header mt-0">
                                <span id="testTitle"></span> —
                                <span class="text-info" id="userName"></span>
                            </h1>
                        </div>
                        <div class="col-xs-6 text-right">
                            <div class="alert alert-success" style="display: inline-block; margin-right: 10px;">
                                ⏰ <span id="timer"></span>
                            </div>
                            <button onclick="submitTest()" class="btn btn-danger">Закончить экзамен</button>
                        </div>
                    </div>

                    <div class="tabpanel">
                        <div class="over-x">
                            <ul class="test-nav" id="questionNav"></ul>
                        </div>

                        <div class="tab-content" id="questionsContent"></div>
                    </div>

                    <div class="text-align">
                        <p class="m-t-lg"><b id="answeredCount">0</b>/<b id="totalCount">0</b></p>
                        <div class="btn-group">
                            <button class="btn btn-default" onclick="prevQuestion()">← Предыдущий</button>
                            <button class="btn btn-default" onclick="nextQuestion()">Следующий →</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // Проверка авторизации
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'index.html';
        }

        // Получаем ID теста из URL
        const urlParams = new URLSearchParams(window.location.search);
        const testId = parseInt(urlParams.get('id'));

        // Ищем тест по всем разделам
        let selectedTest = null;
        for (const section of DB.sections) {
            const found = section.tests.find(t => t.id === testId);
            if (found) {
                selectedTest = found;
                break;
            }
        }

        if (!selectedTest) {
            alert('Тест с ID ' + testId + ' не найден!');
            window.location.href = 'tests.html';
        }

        // Фильтруем вопросы по testId
        const questions = DB.questions.filter(q => q.testId === testId);

        if (questions.length === 0) {
            alert('Для этого теста нет вопросов!');
            window.location.href = 'tests.html';
        }

        let currentQuestion = 0;
        let answers = {};
        let startTime = Date.now();
        let endTime = startTime + (selectedTest.duration * 60 * 1000);

        // Заполняем заголовок
        document.getElementById('testTitle').textContent = selectedTest.title;
        document.getElementById('userName').textContent = currentUser.fullName;
        document.getElementById('totalCount').textContent = questions.length;

        // Навигация по вопросам
        const nav = document.getElementById('questionNav');
        questions.forEach((q, i) => {
            const li = document.createElement('li');
            li.innerHTML = `<a href="#" onclick="goToQuestion(${i}); return false;">${i+1}</a>`;
            if (i === 0) li.classList.add('active');
            nav.appendChild(li);
        });

        // Создание вопросов
        const content = document.getElementById('questionsContent');
        questions.forEach((q, i) => {
            const questionContent = q.isImage
                ? `<img src="${q.question}" class="question-image" alt="Вопрос ${i+1}">`
                : `<p>${q.question}</p>`;

            const optionsHtml = ['A', 'B', 'C', 'D'].map(opt => {
                const key = 'option' + opt;
                const optionContent = q.optionIsImage
                    ? `<img src="${q[key]}" class="option-image" alt="Вариант ${opt}">`
                    : `<p>${q[key]}</p>`;

                return `
                    <li>
                        <input type="radio" class="test-radio" id="q${i}${opt.toLowerCase()}" 
                               name="q${i}" value="${opt.toLowerCase()}"
                               onchange="selectAnswer(${i}, '${opt.toLowerCase()}')">
                        <label for="q${i}${opt.toLowerCase()}">
                            <span class="test-variant">${opt}</span>
                            ${optionContent}
                        </label>
                    </li>
                `;
            }).join('');

            const qHtml = `
                <div class="tab-pane ${i===0 ? 'active in' : 'fade'}" id="q${i}">
                    <div class="test-question">${questionContent}</div>
                    <div class="label label-info">Балл: ${q.points}</div>
                    <div class="test-content m-t-xs">
                        <ul class="answers-test">
                            ${optionsHtml}
                        </ul>
                    </div>
                </div>
            `;
            content.innerHTML += qHtml;
        });

        // Выбор ответа
        function selectAnswer(qIndex, answer) {
            answers[qIndex] = answer;
            document.querySelectorAll('.test-nav li')[qIndex].classList.add('btn-primary');
            document.getElementById('answeredCount').textContent = Object.keys(answers).length;

            // Авто-переход к следующему (можно убрать)
            if (qIndex < questions.length - 1) {
                setTimeout(() => goToQuestion(qIndex + 1), 400);
            }
        }

        // Переход к вопросу
        function goToQuestion(index) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active', 'in'));
            document.querySelectorAll('.test-nav li').forEach(l => l.classList.remove('active'));
            document.getElementById('q' + index).classList.add('active', 'in');
            document.querySelectorAll('.test-nav li')[index].classList.add('active');
            currentQuestion = index;
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) goToQuestion(currentQuestion + 1);
        }

        function prevQuestion() {
            if (currentQuestion > 0) goToQuestion(currentQuestion - 1);
        }

        // Завершение теста
        function submitTest() {
            if (confirm('Вы уверены, что хотите завершить тест?')) {
                let score = 0;
                let maxScore = 0;

                const results = questions.map((q, i) => {
                    maxScore += q.points;
                    const userAns = answers[i];
                    const isCorrect = userAns === q.correctAnswer;
                    if (isCorrect) score += q.points;
                    return {
                        questionId: q.id,
                        question: q.isImage ? '(изображение)' : q.question,
                        userAnswer: userAns || '—',
                        correctAnswer: q.correctAnswer,
                        isCorrect,
                        points: isCorrect ? q.points : 0
                    };
                });

                const result = {
                    id: Date.now(),
                    userId: currentUser.id,
                    testId: testId,
                    testTitle: selectedTest.title,
                    score,
                    maxScore,
                    percentage: Math.round((score / maxScore) * 100 * 100) / 100,
                    date: new Date().toLocaleString('ru-RU'),
                    durationUsed: Math.round((Date.now() - startTime) / 1000 / 60) + ' мин',
                    details: results
                };

                // Сохранение результата
                const allResults = JSON.parse(localStorage.getItem('testResults') || '[]');
                allResults.push(result);
                localStorage.setItem('testResults', JSON.stringify(allResults));

                // Переход на результат
                window.location.href = 'result.html?id=' + result.id;
            }
        }

        // Таймер
        setInterval(() => {
            const now = Date.now();
            const diff = Math.max(0, endTime - now);
            const hours = Math.floor(diff / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);

            document.getElementById('timer').textContent =
                `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            if (diff <= 0) {
                alert('Время вышло! Тест завершается автоматически.');
                submitTest();
            }
        }, 1000);
    </script>
</body>
</html>
